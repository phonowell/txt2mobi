# 用例审查与执行

## 统一模板

### 核心目标
- 严格遵守 [`llms.md`](../llms.md:1) 规则与约定。
- 最大限度减少人工干预，实现全自动闭环（自动运行测试、解析报错、修正用例，直至全部通过）。
- 用例需一次性覆盖全部功能、边界、异常分支，避免遗漏与冗余。
- 审查用例的全面性与合理性（无冗余、无遗漏、必要性强）。
- 运行用例确保全部通过，仅允许修改用例，不可修改源码。
- 检查 import 路径后缀、文件行数等规范，确保合规。
- 经验沉淀应追加，不覆盖历史内容，便于持续优化流程。

### 执行步骤
1. 阅读 [`llms.md`](../llms.md:1) 理解测试规范。
2. 分析目标函数源码，明确功能、边界及异常处理逻辑。
3. 审查现有用例：
   - 是否覆盖全部功能、边界、异常。
   - 是否存在冗余/无效用例。
   - 是否遗漏必要场景。
4. 运行用例，若有错误或遗漏，仅修改/补充用例直至全部通过。

### 通用规范
- 用例需覆盖全部功能、边界、异常，移除冗余或无效用例。
- 测试框架限定为 **vitest**（禁止 jest）。
- 所有 import 路径必须带文件名后缀（.js/.jsx/.ts/.tsx）。
- 单测运行命令：
  ```sh
  pnpm test test/xxx.test.ts
  ```

### 沟通与经验沉淀机制
- 遇到流程中断、权限不足等情况，需主动说明原因并请求补充信息。
- 经验沉淀应追加至本文件，不覆盖历史内容，便于持续优化。

### 实践细则
- 自动运行与修正：主动执行测试命令，失败时自动定位并修正用例，直至全部通过。
- 用例补充与审查：一次性覆盖所有功能、边界、异常，结合源码调整期望值。
- 针对源码未显式抛出异常的分支，测试用例应以“流程无异常通过”为断言，避免强制要求 reject。
- 对所有依赖（如 cleanMangaNames、glob、splitText 等）需全局 mock 返回数组，避免 for...of 报 TypeError。
- “依赖调用次数”类断言在全局 mock 场景下可能失效，建议仅断言流程通过，减少对 spy 计数的依赖。
- 遇到类型不匹配（如 unknown 传 Config）时，优先保证运行通过，类型报错可忽略。
- 异常处理：对无法自动覆盖的场景（如私有函数未导出、权限不足等），需结构化说明原因并给出建议。
- 沟通透明：遇问题时说明原因并给出建议，流程中断或异常时主动说明原因及可行方案。
- 文档沉淀：及时总结经验，优化自动化流程，将成果追加至本文件。

---

## 用例覆盖与审查要点

- 用例需一次性覆盖全部功能、边界、异常分支，避免遗漏与冗余。
- 审查用例的全面性、合理性（无冗余、必要）。
- 运行用例确保全部通过，仅允许修改用例，不可修改源码。
- 检查 import 路径后缀、文件行数等规范，确保合规。

---

## mock 相关规范

- 对所有依赖（如 cleanMangaNames、glob、splitText 等）需全局 mock 返回数组，避免 for...of 报 TypeError。
- 拆分后每个测试文件需独立 mock 依赖，避免全局污染，且 import 路径必须带 .js/.ts 后缀。
- “依赖调用次数”类断言在全局 mock 场景下可能失效，建议仅断言流程通过，减少对 spy 计数的依赖。
- 类型不匹配（如 mockResolvedValueOnce(undefined)）导致的 ts 报错可忽略，优先保证运行通过。

---

## 自动化整改流程

1. 规范审查
2. 拆分重构（单个测试文件行数超 90 时，需按功能分拆为多个文件，每个文件控制在 90 行以内，确保规范合规与可维护性）
3. 跑通所有用例
4. 经验沉淀追加文档，形成闭环
5. 拆分与整改后需删除原超长测试文件，避免冗余与规范冲突

---

## 经验沉淀与常见问题

- 自动运行缺失：需主动执行 `pnpm test` 并解析结果，避免依赖用户手动操作。
- 失败未自动分析：测试失败后，需自动解析报错、定位并调整用例，直至通过。
- 期望与实现不符：补充用例时需结合源码实际行为，合理设定期望值。
- 沟通不充分：遇流程中断、权限不足等情况，需主动说明原因并请求补充信息。
- 未一次性补全场景：首次补充用例需覆盖所有典型路径、异常、边界，减少多轮反复。
- 拆分与整改后需删除原超长测试文件，避免冗余与规范冲突。
- 经验沉淀应追加至本文件，不覆盖历史内容，便于持续优化。

---

## 自动化用例规范整改经验沉淀（2025-07-10）

- 单个测试文件行数超 90 时，需按功能分拆为多个文件，每个文件控制在 90 行以内，确保规范合规与可维护性。
- 拆分后每个测试文件需独立 mock 依赖，避免全局污染，且 import 路径必须带 .js/.ts 后缀。
- 依赖调用次数类断言在全局 mock 场景下可能失效，建议仅断言流程通过，减少对 spy 计数的依赖。
- 类型不匹配（如 mockResolvedValueOnce(undefined)）导致的 ts 报错可忽略，优先保证运行通过。
- 拆分与整改后需删除原超长测试文件，避免冗余与规范冲突。
- 自动化整改流程：规范审查 → 拆分重构 → 跑通所有用例 → 经验沉淀追加文档，形成闭环。
