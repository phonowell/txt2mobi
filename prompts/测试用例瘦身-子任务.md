# 测试用例瘦身（子任务模板）

—— 本提示词由主任务按文件逐个调用 ——

输入：

- file: 目标测试文件相对路径（例如 `test/converter.manga.error.test.ts`）
- rules: 判定与取舍规则（来自主任务）
- typeRoots: 源码类型上下文（`src/**/*.ts`、`tsconfig.json`）
- progressPath: `./prompts/refactor-tests-progress.json`

目标：删掉冗余用例与多余 mock，保留必要的最小集。若调用违反 TS 类型签名或依赖 `// @ts-expect-error`，直接删除该用例（不进行重写）。

步骤：

1. 读取 `file` 内容，列出其中的 `describe/it`、`vi.mock` 使用点。
2. 根据 rules 评估：
   - 删除与 TS 类型不符的用例；
   - 合并/删除重复断言；
   - 最小化 mock：只保留有断言价值的函数；
   - 减少噪音重置：移除不必要的 `mockResolvedValue` 与重复 `beforeEach`；
   - 修正导入/mock 路径，确保与源码 ESM 路径一致（相对/后缀与实现一致）。
3. 修改文件并保存。
4. 运行快速校验：
   - `pnpm test <file>`；
   - `tsc -p tsconfig.json --noEmit`；
   - 若失败无法在小范围内修复，则回滚变更，将该文件标记为 `skipped`，写入原因。
5. 更新 `progressPath`：
   - `files[file]`：status、kept、removed、notes；
   - 累加 `totals` 中的计数；
   - 写入 `updatedAt`。

注意：

- 对 `convertManga` 一类公共 API：
  - 保留 1 条“mobiExists 为 true 跳过”的分支用例；
  - 保留 1-2 条“正常流程”断言调用链（processImages → convertToMobi → moveToKindle）；
  - 删除传错类型的输入（例如传 `[]`）。
- 只要全量测试依旧通过即可视为成功，即使覆盖率略有下降也可接受，但尽量减少下降。

输出：

- 对 `file` 的最小修改；
- `progressPath` 中对应项与 totals 的更新。
