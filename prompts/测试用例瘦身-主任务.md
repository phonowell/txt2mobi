# 测试用例瘦身（主任务｜可恢复）

目标：遍历并瘦身 `./test` 下的全部 Vitest 用例，移除冗余，仅保留必要且合理的用例；尽量减少 mock；凡与 TypeScript 类型定义不符的用例一律移除。采用“主-从任务”模式并将进度记录到 `./prompts/refactor-tests-progress.json` 以便中断后恢复。

—— 本提示词交给 cline 或 roo code 作为“主任务”运行 ——

## 项目上下文

- 测试框架：Vitest（ESM）
- 语言：TypeScript（strict, noEmit）
- 脚本：
  - 测试：`pnpm test`（或 `npm run test`）
  - 任务脚本：`pnpm task`
- 关键源码：
  - `src/core/*.ts`（如 `converter.ts` 导出 `convertManga(config: Config)` 等）
  - `src/utils/*.ts`
- 约束：
  - mock 要少且必要；
  - 若用例调用方式违反 TS 类型（例如将 `[]` 传给 `convertManga(config: Config)`），视为冗余并移除；
  - ESM 路径需与源码一致（测试中 mock/导入的模块路径必须能被代码实际引用）。

## 判定与取舍规则（务必执行）

1. 类型一致性优先：凡依赖 `// @ts-expect-error` 或与类型签名不符的调用，一律删除该用例，不做重写（本轮只做瘦身）。
2. 减少 mock：
   - 仅在边界处 mock（如 `fire-keeper`、真实 IO/FS）；
   - 对内部函数（如 `processImages/convertToMobi/moveToKindle`）如需断言调用，可对其所在模块进行最小化 mock，仅保留确有断言的函数，移除未使用的 mock 与多余的 `mockResolvedValue`；
   - 去掉只断言“未被调用”的冗余用例，除非该分支是系统关键路径（例如“存在 mobi 时跳过转换”仅保留 1 条）。
3. 去重与合并：
   - 重复断言同一路径/行为的用例，保留覆盖更清晰的一条；
   - 合并只因数据微小差异而本质相同的测试。
4. 覆盖意图：保留“公共 API 的关键路径 + 代表性异常/边界”即可：
   - 例如 `convertManga`：
     - 名称清理被调用；
     - `glob` 找到/找不到源的路径；
     - `mobiExists` 为 true 时跳过后续步骤；
     - 正常路径会调用 `processImages → convertToMobi → moveToKindle`；
     - 末尾清理临时目录。
5. 断言质量：
   - 只断言必要行为（调用顺序/是否调用/关键参数）；避免对实现细节做脆弱断言。

## 进度记录（可恢复执行）

- 进度文件：`./prompts/refactor-tests-progress.json`
- JSON 结构（由本主任务读/写）：

```json
{
  "version": 1,
  "status": "idle|running|paused|done",
  "startedAt": "",
  "updatedAt": "",
  "totals": {
    "queued": 0,
    "processed": 0,
    "edited": 0,
    "removed": 0,
    "skipped": 0,
    "failures": 0
  },
  "files": {
    "relative/path/to/file.test.ts": {
      "status": "queued|processing|done|skipped|failed",
      "reason": "",
      "kept": 0,
      "removed": 0,
      "notes": "",
      "commits": ["<sha?>"]
    }
  }
}
```

- 原则：
  - 首次运行若文件不存在，请创建并写入上述骨架；
  - 每处理完 1 个测试文件，立刻更新对应条目与 `totals`；
  - 支持中断恢复：再次运行时仅挑选 `status=queued|failed` 的文件继续。

## 执行步骤（主-从任务编排）

1. 初始化
   - 安装依赖并在当前分支执行基础验证：
     - 运行一次类型检查：`tsc -p tsconfig.json --noEmit`
     - 运行一次测试：`pnpm test`
   - 收集测试文件列表：`test/**/*.test.ts`（按字母序稳定排序），写入进度文件 `files` 字段为 `queued`。
2. 分批处理（建议每批 2-4 个文件，避免大冲突）：
   - 对于每个 `status=queued` 的文件：
     - 以“子任务”提示词（见子任务模板）单独处理该文件；
     - 子任务完成后必须：
       - 运行该文件的快速测试：`pnpm test <file>`；
       - 运行类型检查：`tsc -p tsconfig.json --noEmit`；
       - 更新进度（`done/edited/removed/skipped/failed` 等计数）。
   - 每批结束：
     - 执行一次全量 `pnpm test`；
     - 若无失败则提交变更：`feat(test): slim tests batch N`，并在进度文件 `updatedAt` 标记时间。
3. 完成与收尾
   - 全量 `pnpm test --coverage`（若可用）并记录覆盖率变化到进度文件 `notes`；
   - 将 `status` 置为 `done`。

## 子任务输入与产出契约

- 输入：
  - `file`: 目标测试文件相对路径（例如 `test/converter.manga.error.test.ts`）
  - `rules`: 即本主任务“判定与取舍规则”
  - `typeRoots`: 源码类型上下文（读取 `src/**/*.ts`、`tsconfig.json`）
  - `progressPath`: `./prompts/refactor-tests-progress.json`
- 产出：
  - 对该文件的最小必要修改（删除冗余 `describe/it`、移除多余 `vi.mock`、修正导入路径），保持通过；
  - 更新进度统计（kept/removed/edited）；
  - 若无法在保持通过的前提下瘦身，标注为 `skipped` 并记录原因。

## 质量闸（每次变更后执行）

- PASS 类型检查：`tsc -p tsconfig.json --noEmit`
- PASS 目标文件的 `pnpm test <file>`
- 批次结束时 PASS 全量 `pnpm test`

## 典型判断示例（对齐本仓库）

- 删除：`convertManga([])` 这类违反签名的用例（`convertManga(config: Config)`）。
- 保留：`mobiExists` 返回 `true` 时跳过后续步骤（1 条即可）。
- 合理 mock：
  - 允许对 `./processor.js` 做最小化 mock 以便断言 `processImages/convertToMobi/moveToKindle` 被调用；
  - 允许对 `fire-keeper`、`../utils/kindle.js`、`../utils/file.js` 做边界 mock；
  - 移除未使用的 mock/多余的 `mockResolvedValue`/重复 `beforeEach` 重置。

## 提交规范

- 每批提交信息：`feat(test): slim tests batch <N> [<summary>]`
- 若跳过/失败，附带原因到进度文件，不提交破坏性变更。

---

执行时请严格遵守以上步骤；若发生中断，读取并依据 `refactor-tests-progress.json` 恢复执行，仅处理 `queued|failed` 文件。
